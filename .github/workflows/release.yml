name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing tag to release (for example: v0.1.6)"
        required: true
        type: string

permissions:
  contents: write
  id-token: write

concurrency:
  group: release-${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref }}
  cancel-in-progress: false

jobs:
  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      tag_version: ${{ steps.meta.outputs.tag_version }}
      pkg_name: ${{ steps.meta.outputs.pkg_name }}
      pkg_version: ${{ steps.meta.outputs.pkg_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Run tests
        run: go test ./...

      - name: Verify release metadata
        id: meta
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            RELEASE_TAG="${{ github.event.inputs.tag }}"
          else
            RELEASE_TAG="${GITHUB_REF_NAME}"
          fi

          TAG_VERSION="${RELEASE_TAG#v}"
          PKG_NAME="$(node -p "require('./npm/package.json').name")"
          PKG_VERSION="$(node -p "require('./npm/package.json').version")"

          if [ "$RELEASE_TAG" = "$TAG_VERSION" ]; then
            echo "Tag must start with 'v', got: $RELEASE_TAG"
            exit 1
          fi

          if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
            echo "Tag version ($TAG_VERSION) must match npm/package.json version ($PKG_VERSION)."
            exit 1
          fi

          if ! echo "$TAG_VERSION" | grep -Eq '^[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?(\+[0-9A-Za-z.-]+)?$'; then
            echo "Tag version must be semver-compatible, got: $TAG_VERSION"
            exit 1
          fi

          REPO_URL="$(node -p "require('./npm/package.json').repository.url || ''")"
          if [ -z "$REPO_URL" ]; then
            echo "npm/package.json repository.url must be configured."
            exit 1
          fi

          if echo "$REPO_URL" | grep -q "REPO_OWNER/REPO_NAME"; then
            echo "npm/package.json repository.url still contains placeholder REPO_OWNER/REPO_NAME."
            exit 1
          fi

          if grep -R "REPO_OWNER/REPO_NAME" npm/bin/install.js npm/README.md; then
            echo "Found unreplaced placeholder REPO_OWNER/REPO_NAME in npm wrapper files."
            exit 1
          fi

          echo "tag_version=$TAG_VERSION" >> "$GITHUB_OUTPUT"
          echo "pkg_name=$PKG_NAME" >> "$GITHUB_OUTPUT"
          echo "pkg_version=$PKG_VERSION" >> "$GITHUB_OUTPUT"

  release-binaries:
    name: Release Binaries
    runs-on: ubuntu-latest
    needs: validate-release
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref }}

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: "~> v2"
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish-npm:
    name: Publish npm
    runs-on: ubuntu-latest
    needs:
      - validate-release
      - release-binaries
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          registry-url: "https://registry.npmjs.org"

      - name: Dry-run npm pack
        run: npm pack --dry-run
        working-directory: npm

      - name: Detect existing npm version
        id: npm-version
        run: |
          if npm view "${{ needs.validate-release.outputs.pkg_name }}@${{ needs.validate-release.outputs.pkg_version }}" version > /dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
            echo "Package version already exists on npm, publish step will be skipped."
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish to npm
        if: steps.npm-version.outputs.exists != 'true'
        run: npm publish --provenance --access public
        working-directory: npm
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
